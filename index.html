<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PWA Bridge</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#007bff">
</head>
<body style="font-family: sans-serif; text-align: center; padding: 20px;">
    <h2>PWA Middleman Active</h2>
    <p id="status">Ready to bridge requests...</p>

    <script>
		/*window.onload = () => {
   			window.parent.postMessage({ type: "BRIDGE_READY" }, "*");
		};*/
        // Listen for messages from the top-level Web App
        window.addEventListener("message", async (event) => {
			const {type, targetUrl, options } = event.data;
			
			if (type === "HEARTBEAT_CHECK") {
				await handleHeartbeat(event, targetUrl);
			}else{
				await handleRequest(event, targetUrl, options);
			}
		});
		async function handleHeartbeat(event, targetUrl) {

			try {
				const controller = new AbortController();
				const timer = setTimeout(() => controller.abort(), 2000);

				const response = await fetch(targetUrl, { 
					method: 'GET',
					signal: controller.signal,
					// Keep the Private Network header context
					headers: { 'Accept': 'application/json' }
				});
				
				clearTimeout(timer);
				const json = await response.json();

				event.source.postMessage({ 
					type: 'HEARTBEAT_STATUS', 
					online: json.status === "ok",
					serverData: json // Pass back the {"status":"ok"}
				}, event.origin);

			} catch (err) {
				event.source.postMessage({ 
					type: 'HEARTBEAT_STATUS', 
					online: false,
					error: err.message 
				}, event.origin);
			}
		}

		async function handleRequest(event, targetUrl, options) {
			try {
				const response = await fetch(targetUrl, options);
				const result = await response.json();
				event.source.postMessage({ status: 'success', data: result }, event.origin);
			} catch (err) {
				event.source.postMessage({ status: 'error', message: err.message }, event.origin);
			}
		}
        // Register the Service Worker for installation
        if ('serviceWorker' in navigator) {
			navigator.serviceWorker.register('./sw.js').then(reg => {
				// Wait until the service worker is active and controlling the page
				navigator.serviceWorker.ready.then(() => {
					// Give the browser a tiny moment to ensure the 'controller' is set
					setTimeout(() => {
						window.parent.postMessage({ type: "BRIDGE_READY" }, "*");
					}, 100);
				});
			});
		}
    </script>
</body>
</html>
